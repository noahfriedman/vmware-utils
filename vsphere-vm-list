#!/usr/bin/env python
# vsphere-vm-list --- display name of all known virtual machines

# Author: Noah Friedman <friedman@splode.com>
# Created: 2018-05-08
# Public domain

# $Id: vsphere-vm-list,v 1.4 2018/09/12 19:45:40 friedman Exp $

# Commentary:
# Code:

from   __future__ import print_function
from   pyVmomi    import vim
import vspherelib     as vsl

def get_args():
    p = vsl.ArgumentParser()
    p.add( '-v', '--verbose', action='store_true', help='Display extended info' )
    return p.parse()

def main():
    args = get_args()
    vsi  = vsl.vmomiConnect( args )

    proplist = [ 'name' ]
    if args.verbose:
        proplist.extend( ('config.template', 'runtime.powerState') )

    vmlist = vsi.get_obj_props( [vim.VirtualMachine], proplist )
    vmlist.sort( lambda a, b: cmp( a[ 'name' ], b[ 'name' ]))

    if args.verbose:
        poweredOn = vim.VirtualMachine.PowerState.poweredOn
        for vm in vmlist:
            flag = ' '
            if vm[ 'config.template' ]:
                flag = '+'
            elif vm[ 'runtime.powerState' ] == poweredOn:
                flag = 'o'
            print( flag, vm[ 'name' ] )
    else:
        for vm in vmlist:
            print( vm[ 'name' ] )


if __name__ == '__main__':
    main()

# vsphere-vm-list ends here
